{"version":3,"sources":["fjssz_SceneManager.js"],"names":["app","require","fjssz_SceneManager","BaseClass","extend","Init","JS_Name","SceneInfo","subGameName","GetTableDict","backMusicSoundID","beforeBackMusicSoundName","mapID","sceneName","sceneComponent","loadingNode","isLoading","loadingSceneName","RegEvent","OnEvent_ModalLayer","OnEvent_OnShakeScene","Log","event","WarnLog","OnTopEvent","OnEventHide","OnEventShow","bReConnect","OnShakeScene","LoadScene","isReLoad","console","log","loadFormDict","showFormDict","createingFormDict","formWndShowInfo","defaultFormNameList","that","cc","loader","loadRes","err","prefab","instantiate","game","addPersistRootNode","ReadyLoadScene","hasOwnProperty","error","lastSceneName","lastSceneScriptName","lastSceneScript","find","getComponent","bluebirdObj","LoadSceneDefaultForm","then","StartLoadScene","catch","ErrLog","stack","formPath2RealPath","formPath","indexOf","RealGamePrefab","GamePrefab","gamePrefab","OnBeforeExitScene","director","loadScene","OnLoadSceneEnd","bind","CreateLoadPromise","preloadScene","ShowHelp","eventID","eventNode","PlayMusic","backGroundSound","LocalDataManager","GetConfigProperty","StopSceneMusic","PlayBackMusic","soundID","PauseSceneMusic","PauseSound","RecoverySceneMusic","ResumeSound","StopSoundByAudioID","UpdateSceneMusic","volume","audioEngine","setVolume","removePersistRootNode","removeFromParent","sceneScriptName","node","c","Canvas","heightWidth","winSize","height","width","IsIpad","fitWidth","FormManager","OnSwithSceneEnd","OnShowDefaultForm","OnTimer","passSecond","OnBaseTimer","OnReload","isFirstEnterMainScene","GetSceneType","GetSceneComponent","GetMapID","g_fjssz_SceneManager","exports","GetModel"],"mappings":"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","file":"fjssz_SceneManager.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\scene","sourcesContent":["/*\r\n\t场景管理器\r\n*/\r\n\r\nvar app = require(\"fjssz_app\");\r\n\r\nvar fjssz_SceneManager = app.BaseClass.extend({\r\n\r\n\tInit: function () {\r\n\t\tthis.JS_Name = app[\"subGameName\"] + \"_SceneManager\";\r\n\r\n\t\tthis.SceneInfo = app[app.subGameName + \"_SysDataManager\"]().GetTableDict(\"SceneInfo\");\r\n\r\n\t\tthis.backMusicSoundID = -1;\r\n\t\tthis.beforeBackMusicSoundName = \"\";\r\n\r\n\t\tthis.mapID = 0;\r\n\t\tthis.sceneName = \"\";\r\n\t\t//当前场景的组件对象\r\n\t\tthis.sceneComponent = null;\r\n\r\n\t\tthis.loadingNode = null;\r\n\r\n\t\tthis.isLoading = false;\r\n\t\tthis.loadingSceneName = \"\";\r\n\r\n\t\tapp[app.subGameName + \"Client\"].RegEvent(\"ModalLayer\", this.OnEvent_ModalLayer, this);\r\n\t\tapp[app.subGameName + \"Client\"].RegEvent(\"ShakeScene\", this.OnEvent_OnShakeScene, this);\r\n\r\n\t\tthis.Log(\"Init\");\r\n\t},\r\n\r\n\t//---------------回掉事件---------------\r\n\t//显示最顶层layer\r\n\tOnEvent_ModalLayer: function (event) {\r\n\t\tif (!this.sceneComponent) {\r\n\t\t\tthis.WarnLog(\"OnEvent_ModalLayer not sceneName\");\r\n\t\t\treturn\r\n\t\t}\r\n\t\tthis.sceneComponent.OnTopEvent(event);\r\n\t},\r\n\r\n\t//应用切入后台\r\n\tOnEventHide: function () {\r\n\t\tif (!this.sceneComponent) {\r\n\t\t\tthis.WarnLog(\"OnEventHide not sceneName\");\r\n\t\t\treturn\r\n\t\t}\r\n\t\tthis.sceneComponent.OnEventHide();\r\n\t},\r\n\r\n\t//应用显示\r\n\tOnEventShow: function (bReConnect) {\r\n\t\tif (!this.sceneComponent) {\r\n\t\t\tthis.WarnLog(\"OnEventShow not sceneName\");\r\n\t\t\treturn\r\n\t\t}\r\n\t\tthis.sceneComponent.OnEventShow(bReConnect);\r\n\t},\r\n\r\n\tOnEvent_OnShakeScene: function () {\r\n\t\tif (!this.sceneComponent) {\r\n\t\t\tthis.WarnLog(\"OnEvent_ModalLayer not sceneName\");\r\n\t\t\treturn\r\n\t\t}\r\n\t\tthis.sceneComponent.OnShakeScene();\r\n\t},\r\n\t//---------------外部操作接口----------------\r\n\r\n\t//切换场景\r\n\tLoadScene: function (sceneName, mapID = 0, isReLoad = false) {\r\n\t\tif (this.loadingSceneName == sceneName) {\r\n\t\t\tconsole.log(sceneName + \" 场景已经在加载中...\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.loadingSceneName = sceneName;\r\n\t\tif (isReLoad) {\r\n\t\t\t//如果是游戏切换需要释放内存，重新加载\r\n\t\t\t//清理已经加载的界面\r\n\t\t\tapp[app.subGameName + \"_FormManager\"]().loadFormDict = {};\r\n\t\t\tapp[app.subGameName + \"_FormManager\"]().showFormDict = {};\r\n\t\t\tapp[app.subGameName + \"_FormManager\"]().createingFormDict = {};\r\n\t\t\tapp[app.subGameName + \"_FormManager\"]().formWndShowInfo = {};\r\n\t\t\tapp[app.subGameName + \"_FormManager\"]().defaultFormNameList = [];\r\n\t\t}\r\n\t\tif (sceneName != 'loginScene') {\r\n\t\t\t// app[app.subGameName + \"_FormManager\"]().ShowForm(\"UIWaitForm\");\r\n\t\t\tlet that = this;\r\n\t\t\tcc.loader.loadRes(\"ui/fjssz_UIWaitForm\", function (err, prefab) {\r\n\t\t\t\tthat.loadingNode = cc.instantiate(prefab);\r\n\t\t\t\tconsole.log(\"load uiwaitform\");\r\n\t\t\t\tcc.game.addPersistRootNode(that.loadingNode);\r\n\t\t\t\tthat.isLoading = true;\r\n\t\t\t\tthat.ReadyLoadScene(sceneName, mapID);\r\n\t\t\t});\r\n\r\n\t\t} else {\r\n\t\t\tif (!this.SceneInfo.hasOwnProperty(sceneName)) {\r\n\t\t\t\tconsole.error(\"LoadScene(%s) SceneInfo.txt not find\", sceneName);\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tif (this.isLoading) {\r\n\t\t\t\tconsole.error(\"LoadScene(%s) fail doing (%s) loading now\", sceneName, this.sceneName);\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tthis.isLoading = true;\r\n\t\t\tthis.ReadyLoadScene(sceneName, mapID);\r\n\r\n\t\t}\r\n\r\n\r\n\t\t// let that = this;\r\n\t\t// if('clubScene' == sceneName){\r\n\t\t//     app.ClubManager().ChangeOrientationH(false,function(){\r\n\t\t//         that.ReadyLoadScene(sceneName,mapID);\r\n\t\t//     });\r\n\t\t// }\r\n\t\t// else{\r\n\t\t//     if(!app[app.subGameName + \"_FormManager\"]()._isOrientationH()){\r\n\t\t//         app.ClubManager().ChangeOrientationH(true,function(){\r\n\t\t//             that.ReadyLoadScene(sceneName,mapID);\r\n\t\t//         });\r\n\t\t//     }\r\n\t\t//     else{\r\n\t\t//         that.ReadyLoadScene(sceneName,mapID);\r\n\t\t//     }\r\n\t\t// }\r\n\t},\r\n\tReadyLoadScene: function (sceneName, mapID) {\r\n\t\tlet lastSceneName = this.sceneName;\r\n\t\tthis.Log(\"LoadScene((%s,%s) -> (%s,%s))\", lastSceneName, this.mapID, sceneName, mapID);\r\n\t\tthis.mapID = mapID;\r\n\t\tthis.sceneName = sceneName;\r\n\t\tlet lastSceneScriptName = \"\";\r\n\t\tlet lastSceneScript = null;\r\n\t\tlet that = this;\r\n\t\t//如果前一个场景不是启动场景\r\n\t\tif (this.SceneInfo.hasOwnProperty(lastSceneName)) {\r\n\t\t\tlastSceneScriptName = this.SceneInfo[lastSceneName][\"ComponentName\"];\r\n\t\t\t//找到场景对应的脚本组件\r\n\r\n\t\t\tlastSceneScript = cc.find('Canvas').getComponent(lastSceneScriptName);\r\n\t\t}\r\n\r\n\t\tlet bluebirdObj = app[app.subGameName + \"_FormManager\"]().LoadSceneDefaultForm(sceneName);\r\n\r\n\t\t//如果返回异步对象,需要登录异步执行完成,在进入切换场景\r\n\t\tif (bluebirdObj) {\r\n\t\t\tbluebirdObj.then(function () {\r\n\t\t\t\tthat.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n\t\t\t})\r\n\t\t\t\t.catch(function (error) {\r\n\t\t\t\t\tthat.ErrLog(\"LoadSceneDefaultForm(%s) error:%s\", sceneName, error.stack);\r\n\r\n\t\t\t\t\tthat.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n\t\t\t\t})\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n\t\t}\r\n\t},\r\n\tformPath2RealPath: function (formPath) {\r\n\t\tif (formPath.indexOf('/') < 1) {\r\n\t\t\treturn 'ui/' + formPath;\r\n\t\t}\r\n\t\treturn formPath;\r\n\t},\r\n\tRealGamePrefab: function (GamePrefab) {\r\n\t\tGamePrefab = \"game/FJSSZ/UILSPlay\";\r\n\t\treturn this.formPath2RealPath(GamePrefab);\r\n\t},\r\n\tStartLoadScene: function (lastSceneScript, lastSceneScriptName, sceneName) {\r\n\t\t//预加载有戏场景开始\r\n\t\t// console.log(\"StartLoadScene sceneName == \" + sceneName);\r\n\t\t// console.log(\"StartLoadScene SceneInfo == \" + JSON.stringify(this.SceneInfo));\r\n\t\tlet GamePrefab = this.SceneInfo[sceneName].gamePrefab;\r\n\t\tlet that = this;\r\n\t\tif (GamePrefab == 0) {\r\n\t\t\t//退出当前场景\r\n\t\t\tif (lastSceneScript) {\r\n\t\t\t\tlastSceneScript.OnBeforeExitScene();\r\n\t\t\t}\r\n\t\t\t//关闭场景界面和模型\r\n\t\t\tapp[app.subGameName + \"_FormManager\"]().OnBeforeExitScene(lastSceneScriptName);\r\n\t\t\t//加载失败,也要切换进场景\r\n\t\t\tthis.sceneComponent = null;\r\n\t\t\tcc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\r\n\r\n\t\t} else {\r\n\t\t\tapp[app.subGameName + \"_ControlManager\"]().CreateLoadPromise(this.RealGamePrefab(GamePrefab))\r\n\t\t\t\t.then(function (prefab) {\r\n\t\t\t\t\t//退出当前场景\r\n\t\t\t\t\t//加载失败,也要切换进场景\r\n\t\t\t\t\tthat.sceneComponent = null;\r\n\t\t\t\t\tcc.director.preloadScene(sceneName, function () {\r\n\r\n\t\t\t\t\t\tif (lastSceneScript) {\r\n\t\t\t\t\t\t\tlastSceneScript.OnBeforeExitScene();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t//关闭场景界面和模型\r\n\t\t\t\t\t\tapp[app.subGameName + \"_FormManager\"]().OnBeforeExitScene(lastSceneScriptName);\r\n\r\n\t\t\t\t\t\tcc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t})\r\n\t\t\t\t.catch(function (error) {\r\n\t\t\t\t\t//\r\n\t\t\t\t})\r\n\t\t}\r\n\t\t//预加载有戏场景\r\n\r\n\t},\r\n\r\n\tShowHelp: function (eventID, eventNode) {\r\n\t\tif (this.sceneComponent) {\r\n\t\t\tthis.sceneComponent.ShowHelp(eventID, eventNode);\r\n\t\t}\r\n\t},\r\n\r\n\t//播放背景音乐\r\n\tPlayMusic: function (backGroundSound) {\r\n\t\tconsole.log(\"播放背景音乐\", backGroundSound);\r\n\t\tif (!this.SceneInfo.hasOwnProperty(this.sceneName)) {\r\n\t\t\tconsole.error(\"PlayMusic failed, SceneInfo.txt not find:%s\", this.sceneName);\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tif (!backGroundSound) {\r\n\t\t\tbackGroundSound = this.SceneInfo[this.sceneName][\"BackGroundSound\"];\r\n\t\t\t//读取缓存的背景音乐\r\n\t\t\tif (backGroundSound != \"\" && backGroundSound != \"0\") {\r\n\t\t\t\tbackGroundSound = app.LocalDataManager().GetConfigProperty(\"SysSetting\", \"MainBackMusic\");\r\n\t\t\t}\r\n\t\t\t//读取缓存的背景音乐\r\n\t\t}\r\n\r\n\t\tif (backGroundSound == \"0\") {\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\t//如果切换场景时，两个场景播放的背景音乐相同则不需要再次播放\r\n\t\t// if(this.beforeBackMusicSoundName == backGroundSound){\r\n\t\t//     return;\r\n\t\t// }\r\n\t\t//如果背景音乐不同，则先停止上一个场景残留的背景音乐，重新播放新的背景音乐\r\n\t\tthis.StopSceneMusic();\r\n\t\tthis.beforeBackMusicSoundName = backGroundSound;\r\n\r\n\t\tlet that = this;\r\n\t\tapp[app.subGameName + \"_SoundManager\"]().PlayBackMusic(backGroundSound)\r\n\t\t\t.then(function (soundID) {\r\n\t\t\t\tthat.backMusicSoundID = soundID;\r\n\t\t\t})\r\n\t},\r\n\r\n\tPauseSceneMusic: function () {\r\n\t\tif (this.backMusicSoundID != -1) {\r\n\t\t\tapp[app.subGameName + \"_SoundManager\"]().PauseSound(this.backMusicSoundID);\r\n\t\t}\r\n\t},\r\n\tRecoverySceneMusic: function () {\r\n\t\tif (this.backMusicSoundID != -1) {\r\n\t\t\tapp[app.subGameName + \"_SoundManager\"]().ResumeSound(this.backMusicSoundID);\r\n\t\t}\r\n\t},\r\n\tStopSceneMusic: function () {\r\n\t\tif (this.backMusicSoundID != -1) {\r\n\t\t\tapp[app.subGameName + \"_SoundManager\"]().StopSoundByAudioID(this.backMusicSoundID);\r\n\t\t}\r\n\t},\r\n\tUpdateSceneMusic: function () {\r\n\t\tif (this.backMusicSoundID != -1) {\r\n\t\t\tlet volume = app.LocalDataManager().GetConfigProperty(\"SysSetting\", \"BackVolume\");\r\n\t\t\tcc.audioEngine.setVolume(this.backMusicSoundID, volume);\r\n\t\t}\r\n\t},\r\n\t//------------回掉函数-------------------\r\n\r\n\t//场景加载完成回掉\r\n\tOnLoadSceneEnd: function () {\r\n\t\tthis.Log(\"OnLoadSceneEnd sceneName:%s\", this.sceneName);\r\n\r\n\t\tthis.isLoading = false;\r\n\t\tthis.loadingSceneName = \"\";\r\n\t\tconsole.log(\"unload uiwaitform  begein\");\r\n\t\tif (this.loadingNode) {\r\n\t\t\tcc.game.removePersistRootNode(this.loadingNode);\r\n\t\t\tthis.loadingNode.removeFromParent();\r\n\t\t\tthis.loadingNode = null;\r\n\t\t\tconsole.log(\"unload uiwaitform success\");\r\n\t\t}\r\n\r\n\t\tif (!this.SceneInfo.hasOwnProperty(this.sceneName)) {\r\n\t\t\tconsole.error(\"OnLoadSceneEnd SceneInfo.txt not find:(%s)\", this.sceneName);\r\n\t\t\treturn\r\n\t\t}\r\n\t\tlet sceneScriptName = this.SceneInfo[this.sceneName][\"ComponentName\"];\r\n\t\t//找到场景对应的脚本组件\r\n\t\tthis.sceneComponent = cc.find('Canvas').getComponent(sceneScriptName);\r\n\t\tlet node = cc.find('Canvas');\r\n\t\tlet c = node.getComponent(cc.Canvas);\r\n\t\tlet heightWidth = cc.winSize.height / cc.winSize.width;\r\n\t\tif (app[app.subGameName + \"_ComTool\"]().IsIpad() || heightWidth > 0.6) {\r\n\t\t\tc.fitWidth = true;\r\n\t\t} else {\r\n\t\t\tc.fitWidth = false;\r\n\t\t}\r\n\t\tlet FormManager = app[app.subGameName + \"_FormManager\"]();\r\n\r\n\t\tFormManager.OnSwithSceneEnd(this.sceneName);\r\n\t\tif (this.sceneComponent) {\r\n\t\t\tthis.sceneComponent.OnShowDefaultForm();\r\n\t\t\tthis.sceneComponent.OnSwithSceneEnd();\r\n\t\t} else {\r\n\t\t\tconsole.log(\"找不到场景上绑定的组件:\" + sceneScriptName);\r\n\t\t}\r\n\r\n\r\n\t\tthis.PlayMusic();\r\n\t},\r\n\r\n\t//定时回掉\r\n\tOnTimer: function (passSecond) {\r\n\t\tif (this.sceneComponent) {\r\n\t\t\tthis.sceneComponent.OnBaseTimer(passSecond);\r\n\t\t}\r\n\t},\r\n\r\n\t//切换账号\r\n\tOnReload: function () {\r\n\t\tthis.isFirstEnterMainScene = true;\r\n\t},\r\n\t//-----------------获取接口---------------------------\r\n\r\n\t//获取当前加载的场景名\r\n\tGetSceneType: function () {\r\n\t\treturn this.sceneName;\r\n\t},\r\n\r\n\t//获取当前场景的组件对象\r\n\tGetSceneComponent: function () {\r\n\t\treturn this.sceneComponent\r\n\t},\r\n\r\n\t//获取当前场景的地图ID\r\n\tGetMapID: function () {\r\n\t\treturn this.mapID\r\n\t},\r\n});\r\n\r\n\r\nvar g_fjssz_SceneManager = null;\r\n\r\n/**\r\n * 绑定模块外部方法\r\n */\r\nexports.GetModel = function () {\r\n\tif (!g_fjssz_SceneManager) {\r\n\t\tg_fjssz_SceneManager = new fjssz_SceneManager();\r\n\t}\r\n\treturn g_fjssz_SceneManager;\r\n}\r\n\r\n"]}