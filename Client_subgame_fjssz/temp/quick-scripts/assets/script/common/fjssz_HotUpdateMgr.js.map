{"version":3,"sources":["fjssz_HotUpdateMgr.js"],"names":["app","require","fjssz_HotUpdateMgr","BaseClass","extend","Init","console","log","LocalVersion","cc","sys","isNative","_storagePath","jsb","fileUtils","getWritablePath","subGameName","UIRLFILE","customManifestStr","JSON","stringify","versionCompareHandle","versionA","versionB","vA","split","vB","i","length","a","parseInt","b","_am","AssetsManager","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","getState","State","UNINITED","manifest","Manifest","loadLocalManifest","os","OS_ANDROID","setMaxConcurrentTask","CheckUpdate","url","manifestUrl","nativeUrl","loader","md5Pipe","transformURL","getLocalManifest","isLoaded","setEventCallback","CheckCb","bind","checkUpdate","event","getEventCode","EventAssetsManager","NEW_VERSION_FOUND","OnEvent","_checkListener","getLocalVersion","_updating","getVersion","Destroy","g_fjssz_HotUpdateMgr","exports","GetModel"],"mappings":"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","file":"fjssz_HotUpdateMgr.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\common","sourcesContent":["\r\n// Custom manifest removed the following assets:\r\n// 1. res/raw-assets/textures/UI/chat/button_orange.png\r\n// 2. res/raw-assets/textures/UI/chat/gb_inputbox.png\r\n// So when custom manifest used, you should be able to find them in downloaded remote assets\r\n /*\r\n*/\r\nvar app = require(\"fjssz_app\");\r\nvar fjssz_HotUpdateMgr = app.BaseClass.extend({\r\n    // use this for initialization\r\n    Init: function () {\r\n        console.log('fjssz_HotUpdateMgr Init');\r\n\r\n        this.LocalVersion = '';\r\n\r\n        // Hot update is only available in Native build\r\n        if (!cc.sys.isNative){\r\n            console.log(\"cc.sys.inNavite exit,\",cc.sys.isNative);\r\n            return;\r\n        }\r\n    \r\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'ALLGame/' + app.subGameName);\r\n        /// 替换该地址\r\n\t    var UIRLFILE = \"http://222.187.232.68:88/\" + app.subGameName + \"/remote-assets\";\r\n\r\n        var customManifestStr = JSON.stringify({\r\n            'packageUrl': UIRLFILE,\r\n            'remoteManifestUrl': UIRLFILE + '/project.manifest',\r\n            'remoteVersionUrl': UIRLFILE + '/version.manifest',\r\n            'version': '0.0.1',\r\n            'assets': {},\r\n            'searchPaths': []\r\n        });\r\n        var versionCompareHandle = function (versionA, versionB) {\r\n            cc.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\r\n            var vA = versionA.split('.');\r\n            var vB = versionB.split('.');\r\n            for (var i = 0; i < vA.length; ++i) {\r\n                var a = parseInt(vA[i]);\r\n                var b = parseInt(vB[i] || 0);\r\n                if (a === b) {\r\n                    continue;\r\n                }\r\n                else {\r\n                    return a - b;\r\n                }\r\n            }\r\n            if (vB.length > vA.length) {\r\n                return -1;\r\n            }\r\n            else {\r\n                return 0;\r\n            }\r\n        };\r\n\r\n        // Init with empty manifest url for testing custom manifest\r\n        \r\n        this._am = new jsb.AssetsManager('', this._storagePath, versionCompareHandle);\r\n\r\n        // Setup the verification callback, but we don't have md5 check function yet, so only print some message\r\n        // Return true if the verification passed, otherwise return false\r\n        this._am.setVerifyCallback(function (path, asset) {\r\n            // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\r\n            var compressed = asset.compressed;\r\n            // Retrieve the correct md5 value.\r\n            var expectedMD5 = asset.md5;\r\n            // asset.path is relative path and path is absolute.\r\n            var relativePath = asset.path;\r\n            // The size of asset file, but this value could be absent.\r\n            var size = asset.size;\r\n            if (compressed) {\r\n                return true;\r\n            }\r\n            else {\r\n                // console.log(\"Verification passed : \" + relativePath + ' (' + expectedMD5 + ')');\r\n                return true;\r\n            }\r\n        });\r\n\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            var manifest = new jsb.Manifest(customManifestStr, this._storagePath);\r\n            this._am.loadLocalManifest(manifest, this._storagePath);\r\n        }\r\n\r\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n            this._am.setMaxConcurrentTask(2);\r\n        }\r\n    },\r\n\tCheckUpdate: function () {\r\n\t\tif(!cc.sys.isNative){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n\t\t\tvar url = this.manifestUrl.nativeUrl;\r\n\t\t\tif (cc.loader.md5Pipe) {\r\n\t\t\t\turl = cc.loader.md5Pipe.transformURL(url);\r\n\t\t\t}\r\n\t\t\tthis._am.loadLocalManifest(url);\r\n\t\t}\r\n\t\tif (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis._am.setEventCallback(this.CheckCb.bind(this));\r\n\t\tthis._am.checkUpdate();\r\n\t},\r\n\r\n\tCheckCb: function (event) {\r\n\t\tswitch (event.getEventCode())\r\n\t\t{\r\n\t\t\tcase jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n\t\t\t\tconsole.log(\"游戏有新版本\");\r\n\t\t\t\tapp[app.subGameName + \"Client\"].OnEvent('NewVersion');\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\treturn;\r\n\t\t}\r\n\t\tthis._am.setEventCallback(null);\r\n\t\tthis._checkListener = null;\r\n\t},\r\n    //获取本地版本\r\n    getLocalVersion:function(){\r\n        // this.SysLog(\"getLocalVersion version:%s\", this.LocalVersion);\r\n        if (this.LocalVersion == '' && this._am && !this._updating) {\r\n            this.LocalVersion = this._am.getLocalManifest().getVersion();\r\n        }\r\n        return this.LocalVersion;\r\n    },\r\n    Destroy: function () {\r\n         this._am.setEventCallback(null);\r\n    }\r\n});\r\n\r\nvar g_fjssz_HotUpdateMgr = null;\r\n\r\nexports.GetModel = function(){\r\n    if(!g_fjssz_HotUpdateMgr)\r\n        g_fjssz_HotUpdateMgr = new fjssz_HotUpdateMgr();\r\n    return g_fjssz_HotUpdateMgr;\r\n\r\n}"]}