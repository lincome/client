{"version":3,"sources":["pdk_SceneManager.js"],"names":["app","require","pdk_SceneManager","BaseClass","extend","Init","JS_Name","ComTool","subGameName","SceneInfo","GetTableDict","backMusicSoundID","beforeBackMusicSoundName","mapID","sceneName","sceneComponent","loadingNode","isLoading","loadingSceneName","RegEvent","OnEvent_ModalLayer","OnEvent_OnShakeScene","Log","event","WarnLog","OnTopEvent","OnEventHide","OnEventShow","bReConnect","OnShakeScene","LoadScene","isReLoad","console","log","loadFormDict","showFormDict","createingFormDict","formWndShowInfo","defaultFormNameList","that","cc","loader","loadRes","err","prefab","instantiate","game","addPersistRootNode","ReadyLoadScene","hasOwnProperty","ErrLog","lastSceneName","lastSceneScriptName","lastSceneScript","find","getComponent","bluebirdObj","LoadSceneDefaultForm","then","StartLoadScene","catch","error","stack","formPath2RealPath","formPath","indexOf","RealGamePrefab","GamePrefab","gameScene","LocalDataManager","GetConfigProperty","gamePrefab","OnBeforeExitScene","director","loadScene","OnLoadSceneEnd","bind","CreateLoadPromise","preloadScene","ShowHelp","eventID","eventNode","PlayMusic","backGroundSound","StopSceneMusic","PlayBackMusic","soundID","PauseSceneMusic","PauseSound","RecoverySceneMusic","ResumeSound","StopSoundByAudioID","UpdateSceneMusic","volume","audioEngine","setVolume","removePersistRootNode","removeFromParent","sceneScriptName","node","c","Canvas","heightWidth","winSize","height","width","IsIpad","fitWidth","FormManager","OnSwithSceneEnd","OnShowDefaultForm","OnTimer","passSecond","OnBaseTimer","OnReload","isFirstEnterMainScene","GetSceneType","GetSceneComponent","GetMapID","g_pdk_SceneManager","exports","GetModel"],"mappings":"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","file":"pdk_SceneManager.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\scene","sourcesContent":["/*\r\n\t场景管理器\r\n*/\r\n\r\nvar app = require(\"pdk_app\");\r\n\r\nvar pdk_SceneManager = app.BaseClass.extend({\r\n\r\n    Init: function() {\r\n        this.JS_Name = app[\"subGameName\"] + \"_SceneManager\";\r\n        this.ComTool = app[app.subGameName + \"_ComTool\"]();\r\n        this.SceneInfo = app[app.subGameName + \"_SysDataManager\"]().GetTableDict(\"SceneInfo\");\r\n\r\n        this.backMusicSoundID = -1;\r\n        this.beforeBackMusicSoundName = \"\";\r\n\r\n        this.mapID = 0;\r\n        this.sceneName = \"\";\r\n        //当前场景的组件对象\r\n        this.sceneComponent = null;\r\n\r\n        this.loadingNode = null;\r\n\r\n        this.isLoading = false;\r\n        this.loadingSceneName = \"\";\r\n\r\n        app[app.subGameName + \"Client\"].RegEvent(\"ModalLayer\", this.OnEvent_ModalLayer, this);\r\n        app[app.subGameName + \"Client\"].RegEvent(\"ShakeScene\", this.OnEvent_OnShakeScene, this);\r\n\r\n        this.Log(\"Init\");\r\n    },\r\n\r\n    //---------------回掉事件---------------\r\n    //显示最顶层layer\r\n    OnEvent_ModalLayer: function(event) {\r\n        if (!this.sceneComponent) {\r\n            this.WarnLog(\"OnEvent_ModalLayer not sceneName\");\r\n            return\r\n        }\r\n        this.sceneComponent.OnTopEvent(event);\r\n    },\r\n\r\n    //应用切入后台\r\n    OnEventHide: function() {\r\n        if (!this.sceneComponent) {\r\n            this.WarnLog(\"OnEventHide not sceneName\");\r\n            return\r\n        }\r\n        this.sceneComponent.OnEventHide();\r\n    },\r\n\r\n    //应用显示\r\n    OnEventShow: function(bReConnect) {\r\n        if (!this.sceneComponent) {\r\n            this.WarnLog(\"OnEventShow not sceneName\");\r\n            return\r\n        }\r\n        this.sceneComponent.OnEventShow(bReConnect);\r\n    },\r\n\r\n    OnEvent_OnShakeScene: function() {\r\n        if (!this.sceneComponent) {\r\n            this.WarnLog(\"OnEvent_ModalLayer not sceneName\");\r\n            return\r\n        }\r\n        this.sceneComponent.OnShakeScene();\r\n    },\r\n    //---------------外部操作接口----------------\r\n\r\n    //切换场景\r\n    LoadScene: function(sceneName, mapID = 0, isReLoad = false) {\r\n        if (this.loadingSceneName == sceneName) {\r\n            console.log(sceneName + \" 场景已经在加载中...\");\r\n            return;\r\n        }\r\n        this.loadingSceneName = sceneName;\r\n        if (isReLoad) {\r\n            //如果是游戏切换需要释放内存，重新加载\r\n            //清理已经加载的界面\r\n            app[app.subGameName + \"_FormManager\"]().loadFormDict = {};\r\n            app[app.subGameName + \"_FormManager\"]().showFormDict = {};\r\n            app[app.subGameName + \"_FormManager\"]().createingFormDict = {};\r\n            app[app.subGameName + \"_FormManager\"]().formWndShowInfo = {};\r\n            app[app.subGameName + \"_FormManager\"]().defaultFormNameList = [];\r\n        }\r\n        if (sceneName != 'loginScene') {\r\n            // app[app.subGameName + \"_FormManager\"]().ShowForm(\"UIWaitForm\");\r\n            let that = this;\r\n            cc.loader.loadRes(\"ui/\" + app.subGameName + \"_UIWaitForm\", function(err, prefab) {\r\n                that.loadingNode = cc.instantiate(prefab);\r\n                console.log(\"load uiwaitform\");\r\n                cc.game.addPersistRootNode(that.loadingNode);\r\n                that.isLoading = true;\r\n                that.ReadyLoadScene(sceneName, mapID);\r\n            });\r\n\r\n        } else {\r\n            if (!this.SceneInfo.hasOwnProperty(sceneName)) {\r\n                this.ErrLog(\"LoadScene(%s) SceneInfo.txt not find\", sceneName);\r\n                return\r\n            }\r\n\r\n            if (this.isLoading) {\r\n                this.ErrLog(\"LoadScene(%s) fail doing (%s) loading now\", sceneName, this.sceneName);\r\n                return\r\n            }\r\n\r\n            this.isLoading = true;\r\n            this.ReadyLoadScene(sceneName, mapID);\r\n\r\n        }\r\n\r\n\r\n        // let that = this;\r\n        // if('clubScene' == sceneName){\r\n        //     app.ClubManager().ChangeOrientationH(false,function(){\r\n        //         that.ReadyLoadScene(sceneName,mapID);\r\n        //     });\r\n        // }\r\n        // else{\r\n        //     if(!app[app.subGameName + \"_FormManager\"]()._isOrientationH()){\r\n        //         app.ClubManager().ChangeOrientationH(true,function(){\r\n        //             that.ReadyLoadScene(sceneName,mapID);\r\n        //         });\r\n        //     }\r\n        //     else{\r\n        //         that.ReadyLoadScene(sceneName,mapID);\r\n        //     }\r\n        // }\r\n    },\r\n    ReadyLoadScene: function(sceneName, mapID) {\r\n        let lastSceneName = this.sceneName;\r\n        this.Log(\"LoadScene((%s,%s) -> (%s,%s))\", lastSceneName, this.mapID, sceneName, mapID);\r\n        this.mapID = mapID;\r\n        this.sceneName = sceneName;\r\n        let lastSceneScriptName = \"\";\r\n        let lastSceneScript = null;\r\n        let that = this;\r\n        //如果前一个场景不是启动场景\r\n        if (this.SceneInfo.hasOwnProperty(lastSceneName)) {\r\n            lastSceneScriptName = this.SceneInfo[lastSceneName][\"ComponentName\"];\r\n            //找到场景对应的脚本组件\r\n\r\n            lastSceneScript = cc.find('Canvas').getComponent(lastSceneScriptName);\r\n        }\r\n\r\n        let bluebirdObj = app[app.subGameName + \"_FormManager\"]().LoadSceneDefaultForm(sceneName);\r\n\r\n        //如果返回异步对象,需要登录异步执行完成,在进入切换场景\r\n        if (bluebirdObj) {\r\n            bluebirdObj.then(function() {\r\n                    that.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n                })\r\n                .catch(function(error) {\r\n                    that.ErrLog(\"LoadSceneDefaultForm(%s) error:%s\", sceneName, error.stack);\r\n\r\n                    that.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n                })\r\n        } else {\r\n            this.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n        }\r\n    },\r\n    formPath2RealPath: function(formPath) {\r\n        if (formPath.indexOf('/') < 1) {\r\n            return 'ui/' + formPath;\r\n        }\r\n        return formPath;\r\n    },\r\n    RealGamePrefab: function(GamePrefab) {\r\n        const gameScene = app.LocalDataManager().GetConfigProperty(\"SysSetting\", app.subGameName + \"_GameBg\");\r\n        // console.warn('游戏版面xxx选择', gameScene, GamePrefab);\r\n        if (gameScene == 2 && (GamePrefab == 'game/PDK/UIPDK_Play' || GamePrefab == 'game/PDK/UIPDK_SYPlay' || GamePrefab == 'game/PDK/UIPDK_XiuXPlay')) {\r\n            GamePrefab = 'game/PDK/UIPDK_LPPlay';\r\n        } else if (gameScene == 3 && (GamePrefab == 'game/PDK/UIPDK_Play' || GamePrefab == 'game/PDK/UIPDK_LPPlay' || GamePrefab == 'game/PDK/UIPDK_XiuXPlay')) {\r\n            GamePrefab = 'game/PDK/UIPDK_SYPlay';\r\n        } else if (gameScene == 4 && (GamePrefab == 'game/PDK/UIPDK_Play' || GamePrefab == 'game/PDK/UIPDK_LPPlay' || GamePrefab == 'game/PDK/UIPDK_SYPlay')) {\r\n            GamePrefab = 'game/PDK/UIPDK_XiuXPlay';\r\n        }\r\n        return this.formPath2RealPath(GamePrefab);\r\n    },\r\n    StartLoadScene: function(lastSceneScript, lastSceneScriptName, sceneName) {\r\n        //预加载有戏场景开始\r\n        // console.log(\"StartLoadScene sceneName == \" + sceneName);\r\n        // console.log(\"StartLoadScene SceneInfo == \" + JSON.stringify(this.SceneInfo));\r\n        let GamePrefab = this.SceneInfo[sceneName].gamePrefab;\r\n        let that = this;\r\n        //\r\n        if (GamePrefab == 0) {\r\n            //退出当前场景\r\n            if (lastSceneScript) {\r\n                lastSceneScript.OnBeforeExitScene();\r\n            }\r\n            //关闭场景界面和模型\r\n            app[app.subGameName + \"_FormManager\"]().OnBeforeExitScene(lastSceneScriptName);\r\n            //加载失败,也要切换进场景\r\n            this.sceneComponent = null;\r\n            cc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\r\n\r\n        } else {\r\n            app[app.subGameName + \"_ControlManager\"]().CreateLoadPromise(this.RealGamePrefab(GamePrefab))\r\n                .then(function(prefab) {\r\n                    //退出当前场景\r\n                    //加载失败,也要切换进场景\r\n                    that.sceneComponent = null;\r\n                    cc.director.preloadScene(sceneName, function() {\r\n\r\n                        if (lastSceneScript) {\r\n                            lastSceneScript.OnBeforeExitScene();\r\n                        }\r\n                        //关闭场景界面和模型\r\n                        app[app.subGameName + \"_FormManager\"]().OnBeforeExitScene(lastSceneScriptName);\r\n\r\n                        cc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\r\n                    });\r\n                    return;\r\n                })\r\n                .catch(function(error) {\r\n                    //\r\n                })\r\n        }\r\n        //预加载有戏场景\r\n\r\n    },\r\n\r\n    ShowHelp: function(eventID, eventNode) {\r\n        if (this.sceneComponent) {\r\n            this.sceneComponent.ShowHelp(eventID, eventNode);\r\n        }\r\n    },\r\n\r\n    //播放背景音乐\r\n    PlayMusic: function(backGroundSound) {\r\n\r\n        if (!this.SceneInfo.hasOwnProperty(this.sceneName)) {\r\n            this.ErrLog(\"PlayMusic failed, SceneInfo.txt not find:%s\", this.sceneName);\r\n            return\r\n        }\r\n\r\n        if (!backGroundSound) {\r\n            backGroundSound = this.SceneInfo[this.sceneName][\"BackGroundSound\"];\r\n            //读取缓存的背景音乐\r\n            if (backGroundSound != \"\" && backGroundSound != \"0\") {\r\n                backGroundSound = app.LocalDataManager().GetConfigProperty(\"SysSetting\", \"MainBackMusic\");\r\n            }\r\n            //读取缓存的背景音乐\r\n        }\r\n\r\n        if (backGroundSound == \"0\") {\r\n            return\r\n        }\r\n\r\n        //如果切换场景时，两个场景播放的背景音乐相同则不需要再次播放\r\n        // if(this.beforeBackMusicSoundName == backGroundSound){\r\n        //     return;\r\n        // }\r\n        //如果背景音乐不同，则先停止上一个场景残留的背景音乐，重新播放新的背景音乐\r\n        this.StopSceneMusic();\r\n        this.beforeBackMusicSoundName = backGroundSound;\r\n\r\n        let that = this;\r\n        app[app.subGameName + \"_SoundManager\"]().PlayBackMusic(backGroundSound)\r\n            .then(function(soundID) {\r\n                that.backMusicSoundID = soundID;\r\n            })\r\n    },\r\n\r\n    PauseSceneMusic: function() {\r\n        if (this.backMusicSoundID != -1) {\r\n            app[app.subGameName + \"_SoundManager\"]().PauseSound(this.backMusicSoundID);\r\n        }\r\n    },\r\n    RecoverySceneMusic: function() {\r\n        if (this.backMusicSoundID != -1) {\r\n            app[app.subGameName + \"_SoundManager\"]().ResumeSound(this.backMusicSoundID);\r\n        }\r\n    },\r\n    StopSceneMusic: function() {\r\n        if (this.backMusicSoundID != -1) {\r\n            app[app.subGameName + \"_SoundManager\"]().StopSoundByAudioID(this.backMusicSoundID);\r\n        }\r\n    },\r\n    UpdateSceneMusic: function() {\r\n        if (this.backMusicSoundID != -1) {\r\n            let volume = app.LocalDataManager().GetConfigProperty(\"SysSetting\", \"BackVolume\");\r\n            cc.audioEngine.setVolume(this.backMusicSoundID, volume);\r\n        }\r\n    },\r\n    //------------回掉函数-------------------\r\n\r\n    //场景加载完成回掉\r\n    OnLoadSceneEnd: function() {\r\n        this.Log(\"OnLoadSceneEnd sceneName:%s\", this.sceneName);\r\n\r\n        this.isLoading = false;\r\n        this.loadingSceneName = \"\";\r\n        console.log(\"unload uiwaitform  begein\");\r\n        if (this.loadingNode) {\r\n            cc.game.removePersistRootNode(this.loadingNode);\r\n            this.loadingNode.removeFromParent();\r\n            this.loadingNode = null;\r\n            console.log(\"unload uiwaitform success\");\r\n        }\r\n\r\n        if (!this.SceneInfo.hasOwnProperty(this.sceneName)) {\r\n            this.ErrLog(\"OnLoadSceneEnd SceneInfo.txt not find:(%s)\", this.sceneName);\r\n            return\r\n        }\r\n        let sceneScriptName = this.SceneInfo[this.sceneName][\"ComponentName\"];\r\n        //找到场景对应的脚本组件\r\n        this.sceneComponent = cc.find('Canvas').getComponent(sceneScriptName);\r\n        let node = cc.find('Canvas');\r\n        let c = node.getComponent(cc.Canvas);\r\n        let heightWidth = cc.winSize.height / cc.winSize.width;\r\n        if (this.ComTool.IsIpad() || heightWidth > 0.6) {\r\n            c.fitWidth = true;\r\n        } else {\r\n            c.fitWidth = false;\r\n        }\r\n        let FormManager = app[app.subGameName + \"_FormManager\"]();\r\n\r\n        FormManager.OnSwithSceneEnd(this.sceneName);\r\n        if (this.sceneComponent) {\r\n            this.sceneComponent.OnShowDefaultForm();\r\n            this.sceneComponent.OnSwithSceneEnd();\r\n        } else {\r\n            console.log(\"找不到场景上绑定的组件:\" + sceneScriptName);\r\n        }\r\n\r\n\r\n        this.PlayMusic();\r\n    },\r\n\r\n    //定时回掉\r\n    OnTimer: function(passSecond) {\r\n        if (this.sceneComponent) {\r\n            this.sceneComponent.OnBaseTimer(passSecond);\r\n        }\r\n    },\r\n\r\n    //切换账号\r\n    OnReload: function() {\r\n        this.isFirstEnterMainScene = true;\r\n    },\r\n    //-----------------获取接口---------------------------\r\n\r\n    //获取当前加载的场景名\r\n    GetSceneType: function() {\r\n        return this.sceneName;\r\n    },\r\n\r\n    //获取当前场景的组件对象\r\n    GetSceneComponent: function() {\r\n        return this.sceneComponent\r\n    },\r\n\r\n    //获取当前场景的地图ID\r\n    GetMapID: function() {\r\n        return this.mapID\r\n    },\r\n});\r\n\r\n\r\nvar g_pdk_SceneManager = null;\r\n\r\n/**\r\n * 绑定模块外部方法\r\n */\r\nexports.GetModel = function() {\r\n    if (!g_pdk_SceneManager) {\r\n        g_pdk_SceneManager = new pdk_SceneManager();\r\n    }\r\n    return g_pdk_SceneManager;\r\n}"]}